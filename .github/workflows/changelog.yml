name: Update Changelog

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        shell: bash
        run: |
          DATE=$(date +'%Y-%m-%d')
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges HEAD~10..HEAD 2>/dev/null || git log --pretty=format:"- %s" --no-merges -10)
          else
            COMMITS=$(git log --pretty=format:"- %s" --no-merges ${LAST_TAG}..HEAD)
          fi
          
          if [ -z "$COMMITS" ]; then
            echo "No new commits to add"
            exit 0
          fi
          
          ADDED=""
          CHANGED=""
          FIXED=""
          REMOVED=""
          OTHER=""
          
          while IFS= read -r line; do
            case "$line" in
              *feat:*|*add:*) ADDED="${ADDED}${line}"$'\n' ;;
              *fix:*) FIXED="${FIXED}${line}"$'\n' ;;
              *remove:*|*delete:*) REMOVED="${REMOVED}${line}"$'\n' ;;
              *change:*|*update:*|*refactor:*) CHANGED="${CHANGED}${line}"$'\n' ;;
              *) OTHER="${OTHER}${line}"$'\n' ;;
            esac
          done <<< "$COMMITS"
          
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
            echo ""
            echo "## [Unreleased] - ${DATE}"
            echo ""
            [ -n "$ADDED" ] && { echo "### Added"; printf '%s' "$ADDED"; echo ""; }
            [ -n "$CHANGED" ] && { echo "### Changed"; printf '%s' "$CHANGED"; echo ""; }
            [ -n "$FIXED" ] && { echo "### Fixed"; printf '%s' "$FIXED"; echo ""; }
            [ -n "$REMOVED" ] && { echo "### Removed"; printf '%s' "$REMOVED"; echo ""; }
            [ -n "$OTHER" ] && { echo "### Other"; printf '%s' "$OTHER"; echo ""; }
            
            FIRST_VERSION_LINE=$(grep -n "^## \[[0-9]" CHANGELOG.md | head -1 | cut -d: -f1)
            [ -n "$FIRST_VERSION_LINE" ] && tail -n +${FIRST_VERSION_LINE} CHANGELOG.md
          } > CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md
          git diff --staged --quiet || git commit -m "docs: auto-update CHANGELOG [skip ci]"
          git push || echo "Push failed - branch protection may be blocking"
